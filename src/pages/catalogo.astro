---
import Layout from '../layouts/Layout.astro';
import ProductCard from '../components/ProductCard.astro';
import { getProducts, getCategories } from '../lib/firestore';

const productos = await getProducts();
const categorias = await getCategories();
const totalProductos = productos.length;
---

<Layout title="Catálogo" description="Explora nuestra colección de productos impresos en 3D">
  <section class="catalog-section">
    <div class="container">
      <!-- Header -->
      <div class="catalog-header">
        <div class="header-content">
          <div class="header-title-group">
            <span class="page-index mono">Catálogo</span>
            <h1>Nuestra colección</h1>
          </div>
          <p class="catalog-subtitle">
            Explora nuestra selección de piezas únicas impresas en 3D.<br class="hide-mobile" />
            Cada producto está fabricado con precisión y atención al detalle.
          </p>
        </div>
        <div class="header-stats">
          <div class="stat">
            <span class="stat-value mono">{totalProductos}</span>
            <span class="stat-label">Productos</span>
          </div>
          <div class="stat">
            <span class="stat-value mono">{categorias.length}</span>
            <span class="stat-label">Categorías</span>
          </div>
        </div>
      </div>

      <!-- Filters -->
      <div class="catalog-filters" role="tablist" aria-label="Filtrar por categoría">
        <button
          class="filter-btn active"
          data-filter="todos"
          role="tab"
          aria-selected="true"
        >
          <span class="filter-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <rect x="3" y="3" width="7" height="7"/>
              <rect x="14" y="3" width="7" height="7"/>
              <rect x="14" y="14" width="7" height="7"/>
              <rect x="3" y="14" width="7" height="7"/>
            </svg>
          </span>
          <span>Todos</span>
          <span class="filter-count mono">{totalProductos}</span>
        </button>
        {categorias.map(cat => {
          const count = productos.filter(p => p.categoria === cat.slug).length;
          return (
            <button
              class="filter-btn"
              data-filter={cat.slug}
              role="tab"
              aria-selected="false"
            >
              <span>{cat.nombre}</span>
              <span class="filter-count mono">{count}</span>
            </button>
          );
        })}
      </div>

      <!-- Products Grid -->
      <div class="products-grid" role="tabpanel">
        {productos.map((producto, index) => (
          <div
            class="product-item"
            data-categoria={producto.categoria}
            style={`--index: ${index}`}
          >
            <ProductCard
              nombre={producto.nombre}
              imagen={producto.imagenPrincipal || producto.imagenes[0]?.url || ''}
              precio={producto.precio}
              precioOferta={producto.precioOferta}
              slug={producto.slug}
              categoria={producto.categoria}
            />
          </div>
        ))}
      </div>

      <!-- Empty state -->
      <div class="empty-state" id="empty-state" hidden>
        <div class="empty-icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <circle cx="11" cy="11" r="8"/>
            <path d="M21 21l-4.35-4.35"/>
          </svg>
        </div>
        <p class="empty-text">No hay productos en esta categoría</p>
        <button class="btn btn-secondary reset-filter">Ver todos los productos</button>
      </div>
    </div>
  </section>
</Layout>

<script>
  const filterBtns = document.querySelectorAll('.filter-btn');
  const productItems = document.querySelectorAll('.product-item');
  const emptyState = document.getElementById('empty-state');
  const resetBtn = document.querySelector('.reset-filter');

  function filterProducts(filter: string) {
    let visibleCount = 0;

    productItems.forEach((item, index) => {
      const categoria = item.getAttribute('data-categoria');
      const shouldShow = filter === 'todos' || categoria === filter;

      if (shouldShow) {
        (item as HTMLElement).style.display = 'block';
        (item as HTMLElement).style.animationDelay = `${visibleCount * 0.05}s`;
        visibleCount++;
      } else {
        (item as HTMLElement).style.display = 'none';
      }
    });

    // Show/hide empty state
    if (emptyState) {
      emptyState.hidden = visibleCount > 0;
    }
  }

  filterBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      const filter = btn.getAttribute('data-filter') || 'todos';

      // Update active states
      filterBtns.forEach(b => {
        b.classList.remove('active');
        b.setAttribute('aria-selected', 'false');
      });
      btn.classList.add('active');
      btn.setAttribute('aria-selected', 'true');

      filterProducts(filter);
    });
  });

  // Reset filter button
  resetBtn?.addEventListener('click', () => {
    const todosBtn = document.querySelector('[data-filter="todos"]');
    if (todosBtn) {
      (todosBtn as HTMLElement).click();
    }
  });
</script>

<style>
  .catalog-section {
    padding: 40px 0 100px;
  }

  /* Header */
  .catalog-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 40px;
    margin-bottom: 48px;
    padding-bottom: 48px;
    border-bottom: 1px solid var(--color-border);
  }

  .header-content {
    flex: 1;
    max-width: 600px;
  }

  .header-title-group {
    margin-bottom: 16px;
  }

  .page-index {
    display: inline-block;
    font-size: 0.7rem;
    color: var(--color-accent);
    text-transform: uppercase;
    letter-spacing: 0.15em;
    margin-bottom: 8px;
  }

  .catalog-header h1 {
    font-size: clamp(2rem, 5vw, 3rem);
    margin: 0;
    color: var(--color-text);
  }

  .catalog-subtitle {
    font-size: 1rem;
    color: var(--color-text-secondary);
    line-height: 1.7;
    margin: 0;
  }

  .hide-mobile {
    display: inline;
  }

  .header-stats {
    display: flex;
    gap: 32px;
  }

  .stat {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    padding: 20px 28px;
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
  }

  .stat-value {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--color-accent);
  }

  .stat-label {
    font-size: 0.75rem;
    color: var(--color-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  /* Filters */
  .catalog-filters {
    display: flex;
    gap: 8px;
    margin-bottom: 40px;
    flex-wrap: wrap;
  }

  .filter-btn {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    padding: 12px 20px;
    background: var(--color-bg-elevated);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    font-family: 'Archivo', sans-serif;
    font-size: 0.85rem;
    font-weight: 500;
    color: var(--color-text-secondary);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .filter-btn:hover {
    border-color: var(--color-accent);
    color: var(--color-text);
    background: var(--color-accent-glow);
  }

  .filter-btn.active {
    background: var(--color-accent);
    border-color: var(--color-accent);
    color: var(--color-bg);
  }

  .filter-btn.active .filter-count {
    background: rgba(0, 0, 0, 0.2);
    color: var(--color-bg);
  }

  .filter-icon {
    width: 16px;
    height: 16px;
  }

  .filter-icon svg {
    width: 100%;
    height: 100%;
  }

  .filter-count {
    font-size: 0.7rem;
    padding: 3px 8px;
    background: var(--color-surface);
    border-radius: 100px;
    color: var(--color-text-muted);
  }

  /* Products Grid */
  .products-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 24px;
  }

  .product-item {
    animation: fadeInUp 0.4s ease forwards;
    animation-delay: var(--index, 0) * 0.05s;
    opacity: 0;
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Empty state */
  .empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 80px 20px;
    text-align: center;
  }

  .empty-state[hidden] {
    display: none;
  }

  .empty-icon {
    width: 64px;
    height: 64px;
    color: var(--color-text-muted);
    margin-bottom: 20px;
    opacity: 0.5;
  }

  .empty-icon svg {
    width: 100%;
    height: 100%;
  }

  .empty-text {
    font-size: 1.1rem;
    color: var(--color-text-muted);
    margin: 0 0 24px;
  }

  /* Responsive */
  @media (max-width: 900px) {
    .products-grid {
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
    }

    .header-stats {
      flex-direction: column;
      gap: 12px;
    }

    .stat {
      flex-direction: row;
      gap: 12px;
      padding: 14px 20px;
    }
  }

  @media (max-width: 640px) {
    .catalog-section {
      padding: 24px 0 60px;
    }

    .catalog-header {
      flex-direction: column;
      gap: 24px;
      margin-bottom: 32px;
      padding-bottom: 32px;
    }

    .hide-mobile {
      display: none;
    }

    .catalog-subtitle {
      font-size: 0.95rem;
    }

    .header-stats {
      flex-direction: row;
      width: 100%;
    }

    .stat {
      flex: 1;
      justify-content: center;
    }

    .catalog-filters {
      gap: 6px;
      margin-bottom: 24px;
    }

    .filter-btn {
      padding: 10px 14px;
      font-size: 0.8rem;
      gap: 8px;
    }

    .filter-icon {
      display: none;
    }

    .filter-count {
      padding: 2px 6px;
      font-size: 0.65rem;
    }

    .products-grid {
      grid-template-columns: 1fr;
      gap: 16px;
    }

    .empty-state {
      padding: 60px 20px;
    }
  }
</style>
