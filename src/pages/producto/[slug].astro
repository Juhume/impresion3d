---
import Layout from '../../layouts/Layout.astro';
import WhatsAppButton from '../../components/WhatsAppButton.astro';
import ProductCard from '../../components/ProductCard.astro';
import AddToCartButton from '../../components/react/AddToCartButton';
import { getProducts } from '../../lib/firestore';
import type { Product } from '../../types';

export async function getStaticPaths() {
  const productos = await getProducts();

  return productos.map(producto => ({
    params: { slug: producto.slug },
    props: { producto }
  }));
}

interface Props {
  producto: Product;
}

const { producto } = Astro.props;
const base = import.meta.env.BASE_URL;

// Obtener productos relacionados (misma categoría)
const todosProductos = await getProducts();
const productosRelacionados = todosProductos
  .filter(p => p.categoria === producto.categoria && p.slug !== producto.slug)
  .slice(0, 3);

const mensajeWhatsApp = `Hola! Me interesa el producto "${producto.nombre}" que vi en tu web.`;

// ID y precio del producto
const productId = producto.id;
const precioNumerico = producto.precioOferta ?? producto.precio;
const imagenProducto = producto.imagenPrincipal || (producto.imagenes && producto.imagenes[0]?.url) || '/images/placeholder.svg';
const imagenSrc = imagenProducto.startsWith('/') ? `${base}${imagenProducto.slice(1)}` : imagenProducto;

// Calcular descuento
const tieneOferta = producto.precioOferta !== null && producto.precioOferta !== undefined;
const descuento = tieneOferta ? Math.round((1 - producto.precioOferta! / producto.precio) * 100) : 0;

const features = [
  { icon: 'material', label: 'Material PLA ecológico', value: 'PLA+' },
  { icon: 'print', label: 'Impresión bajo demanda', value: 'FDM' },
  { icon: 'color', label: 'Colores personalizables', value: '+20' },
  { icon: 'ship', label: 'Envío a toda España', value: '24-48h' },
];
---

<Layout title={producto.nombre} description={producto.descripcion}>
  <section class="product-detail">
    <div class="container">
      <!-- Breadcrumb -->
      <nav class="breadcrumb" aria-label="Navegación">
        <a href={base} class="breadcrumb-link">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true">
            <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/>
            <polyline points="9 22 9 12 15 12 15 22"/>
          </svg>
          <span>Inicio</span>
        </a>
        <span class="breadcrumb-sep mono" aria-hidden="true">/</span>
        <a href={`${base}catalogo/`} class="breadcrumb-link">
          <span>Catálogo</span>
        </a>
        <span class="breadcrumb-sep mono" aria-hidden="true">/</span>
        <span class="breadcrumb-current">{producto.nombre}</span>
      </nav>

      <!-- Product Content -->
      <div class="product-content">
        <!-- Gallery -->
        <div class="product-gallery">
          <div class="gallery-main">
            <div class="image-container">
              <div class="image-bg" aria-hidden="true"></div>
              <img src={imagenSrc} alt={producto.nombre} />
              {tieneOferta && (
                <span class="discount-badge mono">-{descuento}%</span>
              )}
            </div>
          </div>
          <div class="gallery-info">
            <span class="info-item mono">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true">
                <path d="M12 2L4 7v10l8 5 8-5V7l-8-5z"/>
              </svg>
              Impresión 3D
            </span>
            <span class="info-item mono">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true">
                <circle cx="12" cy="12" r="10"/>
                <path d="M12 6v6l4 2"/>
              </svg>
              Bajo demanda
            </span>
          </div>
        </div>

        <!-- Product Info -->
        <div class="product-info">
          <div class="info-header">
            <span class="product-category mono">{producto.categoria}</span>
            <span class="info-line" aria-hidden="true"></span>
            <span class="product-ref mono">REF: {producto.slug.toUpperCase().slice(0, 8)}</span>
          </div>

          <h1 class="product-name">{producto.nombre}</h1>

          <!-- Price Block -->
          <div class="price-block">
            <div class="price-main">
              {tieneOferta ? (
                <>
                  <span class="price-current mono">{producto.precioOferta?.toFixed(2)}€</span>
                  <span class="price-original mono">{producto.precio.toFixed(2)}€</span>
                </>
              ) : (
                <span class="price-current mono">{producto.precio.toFixed(2)}€</span>
              )}
            </div>
            <span class="price-note">Precio orientativo · IVA incluido</span>
          </div>

          <!-- Description -->
          <div class="product-description">
            <p>{producto.descripcion}</p>
          </div>

          <!-- Actions -->
          <div class="product-actions">
            <AddToCartButton
              client:load
              productId={productId}
              slug={producto.slug}
              nombre={producto.nombre}
              precio={precioNumerico}
              imagen={imagenProducto}
            />

            <div class="actions-divider">
              <span class="divider-line" aria-hidden="true"></span>
              <span class="divider-text mono">o contacta</span>
              <span class="divider-line" aria-hidden="true"></span>
            </div>

            <WhatsAppButton mensaje={mensajeWhatsApp} texto="Consultar por WhatsApp" />

            <p class="response-hint mono">
              <span class="pulse-dot" aria-hidden="true"></span>
              Te respondemos en menos de 24h
            </p>
          </div>

          <!-- Features -->
          <div class="product-features">
            <h3 class="features-title">
              <span class="title-index mono">01</span>
              Características
            </h3>
            <div class="features-grid">
              {features.map(feature => (
                <div class="feature-item">
                  <span class="feature-icon" aria-hidden="true">
                    {feature.icon === 'material' && (
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M6 21c3-3 6-11 14-14-3 8-11 11-14 14zM6 21V10"/>
                      </svg>
                    )}
                    {feature.icon === 'print' && (
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M12 2L4 7v10l8 5 8-5V7l-8-5z"/>
                        <path d="M12 12l8-5M12 12l-8-5M12 12v10"/>
                      </svg>
                    )}
                    {feature.icon === 'color' && (
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <circle cx="12" cy="12" r="10"/>
                        <circle cx="12" cy="12" r="4"/>
                      </svg>
                    )}
                    {feature.icon === 'ship' && (
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M1 3h15v13H1zM16 8h4l3 4v5h-7V8z"/>
                        <circle cx="5.5" cy="18.5" r="2.5"/>
                        <circle cx="18.5" cy="18.5" r="2.5"/>
                      </svg>
                    )}
                  </span>
                  <div class="feature-content">
                    <span class="feature-label">{feature.label}</span>
                    <span class="feature-value mono">{feature.value}</span>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      </div>

      <!-- Related Products -->
      {productosRelacionados.length > 0 && (
        <div class="related-products">
          <div class="related-header">
            <div class="related-title-group">
              <span class="section-index mono">02</span>
              <h2>Productos relacionados</h2>
            </div>
            <a href={`${base}catalogo/`} class="link-ver-todos">
              <span>Ver catálogo</span>
              <span class="link-arrow mono">→</span>
            </a>
          </div>
          <div class="products-grid">
            {productosRelacionados.map((p, index) => (
              <div class="product-wrapper" style={`--index: ${index}`}>
                <ProductCard
                  nombre={p.nombre}
                  imagen={p.imagenPrincipal || (p.imagenes && p.imagenes[0]?.url) || '/images/placeholder.svg'}
                  precio={p.precio}
                  precioOferta={p.precioOferta}
                  slug={p.slug}
                  categoria={p.categoria}
                />
              </div>
            ))}
          </div>
        </div>
      )}
    </div>
  </section>
</Layout>

<style>
  .product-detail {
    padding: 32px 0 100px;
  }

  /* Breadcrumb */
  .breadcrumb {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 12px;
    font-size: 0.85rem;
    margin-bottom: 40px;
  }

  .breadcrumb-link {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    color: var(--color-text-muted);
    transition: color var(--transition-fast);
  }

  .breadcrumb-link:hover {
    color: var(--color-accent);
  }

  .breadcrumb-link svg {
    width: 16px;
    height: 16px;
  }

  .breadcrumb-sep {
    color: var(--color-text-muted);
    font-size: 0.75rem;
  }

  .breadcrumb-current {
    color: var(--color-text);
    font-weight: 500;
  }

  /* Product Content */
  .product-content {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 64px;
    align-items: start;
  }

  /* Gallery */
  .product-gallery {
    position: sticky;
    top: calc(var(--header-height) + 24px);
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .gallery-main {
    background: var(--color-bg-elevated);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    overflow: hidden;
  }

  .image-container {
    position: relative;
    aspect-ratio: 1;
  }

  .image-bg {
    position: absolute;
    inset: 0;
    background:
      linear-gradient(135deg, var(--color-surface) 25%, transparent 25%),
      linear-gradient(225deg, var(--color-surface) 25%, transparent 25%),
      linear-gradient(45deg, var(--color-surface) 25%, transparent 25%),
      linear-gradient(315deg, var(--color-surface) 25%, transparent 25%);
    background-size: 24px 24px;
    background-position: 0 0, 12px 0, 12px -12px, 0 12px;
    opacity: 0.3;
  }

  .image-container img {
    position: relative;
    width: 100%;
    height: 100%;
    object-fit: contain;
    padding: 2rem;
    z-index: 1;
  }

  .discount-badge {
    position: absolute;
    top: 16px;
    left: 16px;
    padding: 8px 14px;
    background: var(--color-accent);
    color: var(--color-bg);
    font-size: 0.75rem;
    font-weight: 600;
    border-radius: 2px;
    z-index: 2;
  }

  .gallery-info {
    display: flex;
    gap: 12px;
  }

  .info-item {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 14px;
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    font-size: 0.7rem;
    color: var(--color-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .info-item svg {
    width: 16px;
    height: 16px;
    color: var(--color-accent);
  }

  /* Product Info */
  .product-info {
    display: flex;
    flex-direction: column;
  }

  .info-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
  }

  .product-category {
    font-size: 0.7rem;
    color: var(--color-accent);
    text-transform: uppercase;
    letter-spacing: 0.1em;
  }

  .info-line {
    flex: 1;
    height: 1px;
    background: var(--color-border);
  }

  .product-ref {
    font-size: 0.65rem;
    color: var(--color-text-muted);
    letter-spacing: 0.05em;
  }

  .product-name {
    font-size: clamp(1.75rem, 4vw, 2.5rem);
    line-height: 1.15;
    margin: 0 0 24px;
    color: var(--color-text);
  }

  /* Price Block */
  .price-block {
    padding: 24px;
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    margin-bottom: 24px;
  }

  .price-main {
    display: flex;
    align-items: baseline;
    gap: 16px;
    margin-bottom: 8px;
  }

  .price-current {
    font-size: 2rem;
    font-weight: 600;
    color: var(--color-text);
  }

  .price-original {
    font-size: 1.1rem;
    color: var(--color-text-muted);
    text-decoration: line-through;
  }

  .price-note {
    font-size: 0.8rem;
    color: var(--color-text-muted);
  }

  /* Description */
  .product-description {
    margin-bottom: 32px;
  }

  .product-description p {
    font-size: 1rem;
    color: var(--color-text-secondary);
    line-height: 1.8;
    margin: 0;
  }

  /* Actions */
  .product-actions {
    margin-bottom: 40px;
    padding-bottom: 40px;
    border-bottom: 1px solid var(--color-border);
  }

  .actions-divider {
    display: flex;
    align-items: center;
    gap: 16px;
    margin: 20px 0;
  }

  .divider-line {
    flex: 1;
    height: 1px;
    background: var(--color-border);
  }

  .divider-text {
    font-size: 0.7rem;
    color: var(--color-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.1em;
  }

  .response-hint {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 16px;
    font-size: 0.7rem;
    color: var(--color-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .pulse-dot {
    width: 8px;
    height: 8px;
    background: var(--color-success);
    border-radius: 50%;
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.5; transform: scale(0.8); }
  }

  /* Features */
  .product-features {
    padding-top: 0;
  }

  .features-title {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 0.85rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-text-muted);
    margin: 0 0 20px;
  }

  .title-index {
    font-size: 0.65rem;
    color: var(--color-accent);
    padding: 6px 10px;
    background: var(--color-accent-glow);
    border: 1px solid var(--color-accent);
    border-radius: 2px;
  }

  .features-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
  }

  .feature-item {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 16px;
    background: var(--color-bg-elevated);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    transition: all var(--transition-fast);
  }

  .feature-item:hover {
    border-color: var(--color-accent);
    background: var(--color-accent-glow);
  }

  .feature-icon {
    width: 32px;
    height: 32px;
    padding: 6px;
    background: var(--color-surface);
    border-radius: var(--radius-sm);
    color: var(--color-accent);
  }

  .feature-icon svg {
    width: 100%;
    height: 100%;
  }

  .feature-content {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .feature-label {
    font-size: 0.8rem;
    color: var(--color-text-secondary);
  }

  .feature-value {
    font-size: 0.7rem;
    color: var(--color-accent);
    letter-spacing: 0.05em;
  }

  /* Related Products */
  .related-products {
    margin-top: 80px;
    padding-top: 60px;
    border-top: 1px solid var(--color-border);
  }

  .related-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 40px;
  }

  .related-title-group {
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .section-index {
    font-size: 0.7rem;
    color: var(--color-accent);
    padding: 6px 12px;
    background: var(--color-accent-glow);
    border: 1px solid var(--color-accent);
    border-radius: 2px;
  }

  .related-products h2 {
    font-size: clamp(1.25rem, 3vw, 1.5rem);
    margin: 0;
    color: var(--color-text);
  }

  .link-ver-todos {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.9rem;
    font-weight: 500;
    color: var(--color-text-secondary);
    text-decoration: none;
    transition: all var(--transition-fast);
  }

  .link-arrow {
    transition: transform var(--transition-fast);
  }

  .link-ver-todos:hover {
    color: var(--color-accent);
  }

  .link-ver-todos:hover .link-arrow {
    transform: translateX(4px);
  }

  .products-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 24px;
  }

  .product-wrapper {
    opacity: 0;
    animation: fadeInUp 0.5s ease forwards;
    animation-delay: calc(var(--index) * 0.1s);
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Responsive */
  @media (max-width: 900px) {
    .products-grid {
      grid-template-columns: repeat(2, 1fr);
    }

    .features-grid {
      grid-template-columns: 1fr;
    }
  }

  @media (max-width: 768px) {
    .product-content {
      grid-template-columns: 1fr;
      gap: 40px;
    }

    .product-gallery {
      position: static;
    }

    .product-name {
      font-size: 1.75rem;
    }

    .price-current {
      font-size: 1.75rem;
    }

    .features-grid {
      grid-template-columns: repeat(2, 1fr);
    }

    .products-grid {
      grid-template-columns: 1fr;
    }
  }

  @media (max-width: 480px) {
    .product-detail {
      padding: 20px 0 60px;
    }

    .breadcrumb {
      font-size: 0.8rem;
      gap: 8px;
      margin-bottom: 24px;
    }

    .breadcrumb-link svg {
      display: none;
    }

    .gallery-info {
      flex-direction: column;
      gap: 8px;
    }

    .product-name {
      font-size: 1.5rem;
      margin-bottom: 20px;
    }

    .price-block {
      padding: 16px;
      margin-bottom: 20px;
    }

    .price-current {
      font-size: 1.5rem;
    }

    .product-description p {
      font-size: 0.95rem;
    }

    .product-actions {
      margin-bottom: 32px;
      padding-bottom: 32px;
    }

    .features-grid {
      grid-template-columns: 1fr;
    }

    .feature-item {
      padding: 14px;
    }

    .related-products {
      margin-top: 48px;
      padding-top: 40px;
    }

    .related-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 24px;
    }
  }
</style>
